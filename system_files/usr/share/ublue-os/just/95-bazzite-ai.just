# vim: set ft=make :

# Install fonts from brew
install-fonts:
    #!/usr/bin/bash
    echo "Installing extra fonts..."
    brew bundle --file=/usr/share/ublue-os/homebrew/bazzite-ai-fonts.Brewfile

# Toggle default boot between Steam Game Mode (gamescope-session) and Desktop
toggle-gamemode ACTION="":
    #!/usr/bin/bash
    # Lets the user pick the default SDDM autologin session.
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    ACTION="{{ ACTION }}"

    IMAGE_INFO="/usr/share/ublue-os/image-info.json"
    BASE_IMAGE_NAME=$(jq -r '."base-image-name"' < "$IMAGE_INFO" 2>/dev/null || echo "silverblue")

    # Determine desktop session based on base image (KDE = kinoite, GNOME = silverblue)
    DESKTOP_SESSION="gnome-wayland.desktop"
    if [[ $BASE_IMAGE_NAME == "kinoite" ]]; then
        DESKTOP_SESSION="plasma.desktop"
    fi

    GAMEMODE_SESSION="gamescope-session.desktop"
    CONFIG_FILE="/etc/sddm.conf.d/zz-steamos-autologin.conf"

    current_session="Unknown"
    if [[ -f $CONFIG_FILE ]]; then
        current_session=$(grep -Po '^Session=\K.*' "$CONFIG_FILE" || true)
    fi
    if [[ -z $current_session ]]; then
        # Fallback guess
        current_session="$DESKTOP_SESSION"
    fi

    status_pretty="Unknown"
    if [[ $current_session == "$GAMEMODE_SESSION" ]]; then
        status_pretty="Game Mode"
    elif [[ $current_session == "$DESKTOP_SESSION" ]]; then
        status_pretty="Desktop"
    else
        status_pretty="$current_session"
    fi

    ACTION_LOWER=${ACTION,,}

    if [[ $ACTION_LOWER == "help" ]]; then
        echo "Usage: ujust toggle-gamemode [gamemode|desktop|status|help]"
        echo "If no action is provided you'll be prompted with a picker."
        exit 0
    fi

    if [[ $ACTION_LOWER == "status" ]]; then
        echo -e "Current default session: ${bold}${status_pretty}${normal} (${current_session})"
        exit 0
    fi

    CHOICE=""
    if [[ -z $ACTION_LOWER ]]; then
        echo -e "Current default boot target: ${bold}${status_pretty}${normal}\n"
        echo "Select the default session to boot into:"
        echo ""
        CHOICE=$(ugum choose \
            "Steam Game Mode" \
            "Desktop Session" \
            "Exit without changes")
    else
        case "$ACTION_LOWER" in
            gamemode) CHOICE="Steam Game Mode" ;;
            desktop) CHOICE="Desktop Session" ;;
            *) echo "Unrecognized action: $ACTION" ; exit 1 ;;
        esac
    fi

    case "$CHOICE" in
        "Steam Game Mode")
            target_session="$GAMEMODE_SESSION"
            target_pretty="Game Mode"
            ;;
        "Desktop Session")
            target_session="$DESKTOP_SESSION"
            target_pretty="Desktop"
            ;;
        "Exit without changes"|"")
            echo "No changes made."
            exit 0
            ;;
        *)
            echo "Unknown selection: $CHOICE" >&2
            exit 1
            ;;
    esac

    if [[ $target_session == "$current_session" ]]; then
        echo "Already set to $target_pretty ($target_session). Nothing to do."
        exit 0
    fi

    echo "Updating autologin session to: $target_pretty ($target_session)"
    update_content=$'# Autogenerated by ujust toggle-gamemode\n[Autologin]\nSession='"$target_session"

    if [[ $EUID -ne 0 ]]; then
        echo "Requesting root privileges..."
        echo "$update_content" | sudo tee "$CONFIG_FILE" > /dev/null
    else
        printf '%s\n' "$update_content" > "$CONFIG_FILE"
    fi

    echo -e "${green}${bold}Success:${normal} Default session set to $target_pretty. Reboot or log out to apply."

# Setup GPU access for containers (pre-installed on all bazzite-ai)
setup-gpu-containers:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    # Check if nvidia-container-toolkit is installed
    if ! command -v nvidia-ctk &> /dev/null; then
        echo -e "${red}${bold}Error:${normal} nvidia-container-toolkit not found."
        echo "nvidia-container-toolkit should be pre-installed on bazzite-ai."
        echo "Please file a bug report if you're seeing this message."
        exit 1
    fi

    # Check for NVIDIA GPU
    if ! lspci | grep -i nvidia &> /dev/null; then
        echo -e "${yellow}${bold}Warning:${normal} No NVIDIA GPU detected."
        echo "CDI configuration will still be generated but may not work."
    fi

    echo "Generating CDI configuration for GPU container access..."

    # Generate CDI specification for Podman GPU passthrough
    if [[ $EUID -ne 0 ]]; then
        sudo nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
    else
        nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
    fi

    echo -e "${green}${bold}Success:${normal} CDI configuration at /etc/cdi/nvidia.yaml"
    echo ""
    echo "GPU-accelerated containers now available:"
    echo "  podman run --device nvidia.com/gpu=all <image>"
    echo "  just run-devcontainer"
    echo ""
    echo "Test GPU access:"
    echo "  just test-cuda-devcontainer"

# Install or update Claude Code CLI
install-claude-code:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing Claude Code CLI${normal}"
    echo "Location: $HOME/.local/bin/claude"
    echo ""

    # Run official installer
    if curl -fsSL https://claude.ai/install.sh | bash; then
        echo ""
        if command -v claude &> /dev/null; then
            echo -e "${green}${bold}✓ Success:${normal} Claude Code installed"
            claude --version
            echo ""
            echo -e "${bold}Auto-updates:${normal} Enabled by default"
            echo "Claude Code checks for updates on startup"
            echo ""
            echo -e "${bold}Usage:${normal} claude [command]"
            echo "Run 'claude --help' for available commands"
        else
            echo -e "${yellow}${bold}Warning:${normal} Installation completed but 'claude' not in PATH"
            echo "You may need to restart your shell or add ~/.local/bin to PATH"
        fi
    else
        echo -e "${red}${bold}✗ Error:${normal} Claude Code installation failed"
        exit 1
    fi

# Check Claude Code installation and auto-update status
check-claude-code:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Claude Code Status${normal}"
    echo ""

    if command -v claude &> /dev/null; then
        echo -e "${green}✓ Installed${normal}"
        echo "Version: $(claude --version 2>&1 | head -1)"
        echo "Location: $(which claude)"
        echo ""
        echo -e "${bold}Auto-update:${normal} Enabled"
        echo "Claude Code automatically checks for updates on each run"
        echo ""
        echo "To update: Run any claude command (updates check automatically)"
    else
        echo -e "${red}✗ Not installed${normal}"
        echo ""
        echo "To install: ujust install-claude-code"
        exit 1
    fi

# Install development tools flatpaks
install-flatpaks-dev:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing Development Tools Flatpaks${normal}"
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

    APPS=("org.flatpak.Builder.BaseApp" "io.podman_desktop.PodmanDesktop" "io.github.dvlv.boxbuddyrs" "io.github.flattool.Warehouse" "it.mijorus.gearlever" "com.github.tchx84.Flatseal" "org.sqlitebrowser.sqlitebrowser" "org.virt_manager.virt-manager")
    for app in "${APPS[@]}"; do
        if ! flatpak list --columns=application | grep -q "^${app}$"; then
            echo -e "  ${bold}Installing ${app}...${normal}"
            flatpak install --system -y flathub "$app" || echo -e "  ${yellow}⚠ Failed: ${app}${normal}"
        else
            echo -e "  ${green}✓ ${app}${normal}"
        fi
    done
    echo -e "${green}${bold}Done!${normal}"

# Install media and graphics flatpaks
install-flatpaks-media:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing Media & Graphics Flatpaks${normal}"
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

    APPS=("org.blender.Blender" "org.gimp.GIMP" "org.inkscape.Inkscape" "org.kde.kdenlive" "org.kde.haruna" "org.kde.gwenview" "com.prusa3d.PrusaSlicer" "com.github.iwalton3.jellyfin-media-player" "org.jellyfin.JellyfinServer")
    for app in "${APPS[@]}"; do
        if ! flatpak list --columns=application | grep -q "^${app}$"; then
            echo -e "  ${bold}Installing ${app}...${normal}"
            flatpak install --system -y flathub "$app" || echo -e "  ${yellow}⚠ Failed: ${app}${normal}"
        else
            echo -e "  ${green}✓ ${app}${normal}"
        fi
    done
    echo -e "${green}${bold}Done!${normal}"

# Install gaming tools flatpaks
install-flatpaks-gaming:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing Gaming Tools Flatpaks${normal}"
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

    APPS=("com.github.Matoking.protontricks" "io.github.fastrizwaan.WineZGUI" "net.davidotek.pupgui2" "net.supertuxkart.SuperTuxKart")
    for app in "${APPS[@]}"; do
        if ! flatpak list --columns=application | grep -q "^${app}$"; then
            echo -e "  ${bold}Installing ${app}...${normal}"
            flatpak install --system -y flathub "$app" || echo -e "  ${yellow}⚠ Failed: ${app}${normal}"
        else
            echo -e "  ${green}✓ ${app}${normal}"
        fi
    done
    echo -e "${green}${bold}Done!${normal}"

# Install communication flatpaks
install-flatpaks-communication:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing Communication Flatpaks${normal}"
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

    APPS=("com.discordapp.Discord" "org.signal.Signal" "org.squidowl.halloy")
    for app in "${APPS[@]}"; do
        if ! flatpak list --columns=application | grep -q "^${app}$"; then
            echo -e "  ${bold}Installing ${app}...${normal}"
            flatpak install --system -y flathub "$app" || echo -e "  ${yellow}⚠ Failed: ${app}${normal}"
        else
            echo -e "  ${green}✓ ${app}${normal}"
        fi
    done
    echo -e "${green}${bold}Done!${normal}"

# Install productivity flatpaks
install-flatpaks-productivity:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing Productivity Flatpaks${normal}"
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

    APPS=("org.mozilla.firefox" "com.google.Chrome" "org.kde.kcalc" "org.kde.kcolorchooser" "org.kde.filelight" "org.kde.okular" "org.qgis.qgis")
    for app in "${APPS[@]}"; do
        if ! flatpak list --columns=application | grep -q "^${app}$"; then
            echo -e "  ${bold}Installing ${app}...${normal}"
            flatpak install --system -y flathub "$app" || echo -e "  ${yellow}⚠ Failed: ${app}${normal}"
        else
            echo -e "  ${green}✓ ${app}${normal}"
        fi
    done
    echo -e "${green}${bold}Done!${normal}"

# Install utilities flatpaks
install-flatpaks-utilities:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing Utilities Flatpaks${normal}"
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

    APPS=("org.remmina.Remmina" "org.kde.krdc" "com.github.unrud.VideoDownloader" "de.leopoldluley.Clapgrep" "org.fkoehler.KTailctl")
    for app in "${APPS[@]}"; do
        if ! flatpak list --columns=application | grep -q "^${app}$"; then
            echo -e "  ${bold}Installing ${app}...${normal}"
            flatpak install --system -y flathub "$app" || echo -e "  ${yellow}⚠ Failed: ${app}${normal}"
        else
            echo -e "  ${green}✓ ${app}${normal}"
        fi
    done
    echo -e "${green}${bold}Done!${normal}"

# Install experimental flatpaks
install-flatpaks-experimental:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing Experimental Flatpaks${normal}"
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

    APPS=("io.github.Dretch.MonomerFlatpakExample" "com.parsecgaming.parsec")
    for app in "${APPS[@]}"; do
        if ! flatpak list --columns=application | grep -q "^${app}$"; then
            echo -e "  ${bold}Installing ${app}...${normal}"
            flatpak install --system -y flathub "$app" || echo -e "  ${yellow}⚠ Failed: ${app}${normal}"
        else
            echo -e "  ${green}✓ ${app}${normal}"
        fi
    done
    echo -e "${green}${bold}Done!${normal}"

# Install all flatpaks
install-flatpaks-all:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing All Flatpaks (38 total)${normal}"
    echo ""

    just install-flatpaks-dev
    just install-flatpaks-media
    just install-flatpaks-gaming
    just install-flatpaks-communication
    just install-flatpaks-productivity
    just install-flatpaks-utilities
    just install-flatpaks-experimental

    echo ""
    echo -e "${green}${bold}✓ All flatpaks installed!${normal}"

# Install pixi package manager
install-pixi:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing pixi.sh${normal}"
    echo "Modern package manager for conda ecosystem"
    echo "Location: $HOME/.pixi/bin/pixi"
    echo ""

    # Check if already installed
    if command -v pixi &> /dev/null; then
        echo -e "${green}✓ pixi already installed${normal}"
        pixi --version
        echo ""
        echo "To update: pixi self-update"
        exit 0
    fi

    # Install to user home directory
    export PIXI_HOME="$HOME/.pixi"
    curl -fsSL https://pixi.sh/install.sh | bash -s -- --yes

    if [ -f "$PIXI_HOME/bin/pixi" ]; then
        echo ""
        echo -e "${green}${bold}✓ Success:${normal} pixi installed"
        "$PIXI_HOME/bin/pixi" --version
        echo ""
        echo -e "${bold}Usage:${normal}"
        echo "  pixi --help"
        echo "  pixi init my-project"
        echo ""
        echo -e "${yellow}Note:${normal} Restart your shell or run: source ~/.bashrc"
    else
        echo -e "${red}${bold}✗ Error:${normal} Installation failed"
        exit 1
    fi

# Install devcontainers CLI
install-devcontainers-cli:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing devcontainers CLI${normal}"
    echo "Container development automation tool"
    echo ""

    # Check if already installed
    if command -v devcontainer &> /dev/null; then
        echo -e "${green}✓ devcontainer already installed${normal}"
        devcontainer --version
        echo ""
        echo "To update: npm update -g @devcontainers/cli"
        exit 0
    fi

    # Configure npm to use user directory if not already set
    if [ "$(npm config get prefix)" = "/usr" ] || [ "$(npm config get prefix)" = "/usr/local" ]; then
        echo "Configuring npm to use user directory..."
        npm config set prefix "$HOME/.npm-global"

        # Add to PATH if not already there
        if ! grep -q ".npm-global/bin" "$HOME/.bashrc" 2>/dev/null; then
            echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> "$HOME/.bashrc"
        fi
    fi

    # Install devcontainers CLI
    echo "Installing @devcontainers/cli..."
    npm install -g @devcontainers/cli

    if command -v devcontainer &> /dev/null; then
        echo ""
        echo -e "${green}${bold}✓ Success:${normal} devcontainers CLI installed"
        devcontainer --version
        echo ""
        echo -e "${bold}Usage:${normal}"
        echo "  devcontainer --help"
        echo "  devcontainer build --workspace-folder ."
        echo ""
        echo -e "${yellow}Note:${normal} Restart your shell or run: source ~/.bashrc"
    else
        echo -e "${red}${bold}✗ Error:${normal} Installation failed"
        echo "You may need to add ~/.npm-global/bin to your PATH"
        exit 1
    fi

# Install all development tools (pixi + devcontainers CLI)
install-dev-tools:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Installing Development Tools${normal}"
    echo ""

    # Install pixi
    echo "1/2 Installing pixi..."
    just install-pixi

    echo ""
    echo "2/2 Installing devcontainers CLI..."
    just install-devcontainers-cli

    echo ""
    echo -e "${green}${bold}✓ All development tools installed${normal}"

# Pull bazzite-ai-container-nvidia using Apptainer
apptainer-pull-container-nvidia tag="latest":
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    TAG="{{ tag }}"
    OUTPUT_NAME="bazzite-ai-container-nvidia_${TAG}.sif"

    echo -e "${bold}Pulling bazzite-ai-container-nvidia via Apptainer${normal}"
    echo "Registry: ghcr.io/atrawog/bazzite-ai-container-nvidia:${TAG}"
    echo "Output: $HOME/${OUTPUT_NAME}"
    echo ""

    cd "$HOME"
    apptainer pull "docker://ghcr.io/atrawog/bazzite-ai-container-nvidia:${TAG}"

    echo ""
    echo -e "${green}${bold}✓ Success${normal}"
    echo "Container saved: $HOME/${OUTPUT_NAME}"
    echo ""
    echo "Run with:"
    echo "  ujust apptainer-run-container-nvidia"

# Pull bazzite-ai-container (base, CPU-only) using Apptainer
apptainer-pull-container tag="latest":
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    TAG="{{ tag }}"
    OUTPUT_NAME="bazzite-ai-container_${TAG}.sif"

    echo -e "${bold}Pulling bazzite-ai-container (base, CPU-only) via Apptainer${normal}"
    echo "Registry: ghcr.io/atrawog/bazzite-ai-container:${TAG}"
    echo "Output: $HOME/${OUTPUT_NAME}"
    echo ""

    cd "$HOME"
    apptainer pull "docker://ghcr.io/atrawog/bazzite-ai-container:${TAG}"

    echo ""
    echo -e "${green}${bold}✓ Success${normal}"
    echo "Container saved: $HOME/${OUTPUT_NAME}"
    echo ""
    echo "Run with:"
    echo "  ujust apptainer-run-container"

# Run bazzite-ai-container-nvidia with Apptainer (GPU enabled)
apptainer-run-container-nvidia tag="latest" workspace="":
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    TAG="{{ tag }}"
    WORKSPACE="{{ workspace }}"
    SIF_FILE="$HOME/bazzite-ai-container-nvidia_${TAG}.sif"

    # Default workspace to current directory
    if [[ -z "${WORKSPACE}" ]]; then
        WORKSPACE="$(pwd)"
    fi

    # Check if container exists
    if [[ ! -f "${SIF_FILE}" ]]; then
        echo -e "${yellow}Container not found: ${SIF_FILE}${normal}"
        echo "Pulling from GHCR..."
        just apptainer-pull-container-nvidia "${TAG}"
    fi

    echo -e "${bold}Starting bazzite-ai-container-nvidia${normal}"
    echo "Workspace: ${WORKSPACE}"
    echo ""

    # Check for GPU
    if command -v nvidia-smi &> /dev/null; then
        echo -e "${green}✓ NVIDIA GPU detected - enabling GPU support${normal}"
        GPU_FLAG="--nv"
    else
        echo "No GPU detected - running in CPU-only mode"
        GPU_FLAG=""
    fi

    echo ""
    echo "Starting interactive shell..."

    # Run with GPU support, writable tmpfs, and workspace bind
    apptainer shell \
        ${GPU_FLAG} \
        --writable-tmpfs \
        --bind "${WORKSPACE}:/workspace" \
        --pwd /workspace \
        "${SIF_FILE}"

# Run bazzite-ai-container with Apptainer (base, CPU only)
apptainer-run-container tag="latest" workspace="":
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    TAG="{{ tag }}"
    WORKSPACE="{{ workspace }}"
    SIF_FILE="$HOME/bazzite-ai-container_${TAG}.sif"

    if [[ -z "${WORKSPACE}" ]]; then
        WORKSPACE="$(pwd)"
    fi

    if [[ ! -f "${SIF_FILE}" ]]; then
        echo "Pulling container..."
        just apptainer-pull-container "${TAG}"
    fi

    echo -e "${bold}Starting bazzite-ai-container (base, CPU-only)${normal}"

    apptainer shell \
        --writable-tmpfs \
        --bind "${WORKSPACE}:/workspace" \
        --pwd /workspace \
        "${SIF_FILE}"

# Execute command in bazzite-ai-container-nvidia via Apptainer
apptainer-exec-container-nvidia cmd tag="latest" workspace="":
    #!/usr/bin/bash
    set -euo pipefail

    TAG="{{ tag }}"
    CMD="{{ cmd }}"
    WORKSPACE="{{ workspace }}"
    SIF_FILE="$HOME/bazzite-ai-container-nvidia_${TAG}.sif"

    if [[ -z "${WORKSPACE}" ]]; then
        WORKSPACE="$(pwd)"
    fi

    if [[ ! -f "${SIF_FILE}" ]]; then
        echo "Container not found. Run: ujust apptainer-pull-container-nvidia"
        exit 1
    fi

    if command -v nvidia-smi &> /dev/null; then
        GPU_FLAG="--nv"
    else
        GPU_FLAG=""
    fi

    apptainer exec \
        ${GPU_FLAG} \
        --writable-tmpfs \
        --bind "${WORKSPACE}:/workspace" \
        --pwd /workspace \
        "${SIF_FILE}" \
        ${CMD}

# Show Apptainer setup information
apptainer-info:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Apptainer Container Platform${normal}"
    echo "HPC and scientific computing optimized"
    echo ""
    apptainer version
    echo ""

    if command -v nvidia-smi &> /dev/null; then
        echo -e "${green}✓ NVIDIA GPU detected${normal}"
        echo "Use --nv flag for GPU support"
    else
        echo "No NVIDIA GPU detected (CPU-only mode available)"
    fi

    echo ""
    echo -e "${bold}Quick Start:${normal}"
    echo "  # GPU Development (NVIDIA)"
    echo "  ujust apptainer-pull-container-nvidia   # Download NVIDIA container"
    echo "  ujust apptainer-run-container-nvidia    # Interactive shell with GPU"
    echo ""
    echo "  # CPU-Only Development"
    echo "  ujust apptainer-pull-container          # Download base container"
    echo "  ujust apptainer-run-container           # Interactive shell (CPU)"
    echo ""
    echo "Documentation: https://apptainer.org/docs/"

# Launch WinBoat for Windows app integration
winboat-launch:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Launching WinBoat${normal}"
    echo "Windows app integration platform"
    echo ""

    if ! command -v winboat &> /dev/null; then
        echo -e "${red}${bold}Error:${normal} WinBoat not installed"
        echo "WinBoat should be pre-installed in bazzite-ai"
        exit 1
    fi

    # Check Docker is running
    if ! systemctl is-active --quiet docker; then
        echo "Starting Docker service..."
        sudo systemctl start docker
    fi

    winboat

# Show WinBoat information
winboat-info:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}WinBoat - Windows App Integration${normal}"
    echo "Run Windows applications with seamless Linux integration"
    echo ""

    if command -v winboat &> /dev/null; then
        echo -e "${green}✓ WinBoat installed${normal}"
    else
        echo -e "${red}✗ WinBoat not installed${normal}"
        exit 1
    fi

    if command -v xfreerdp &> /dev/null; then
        echo -e "${green}✓ FreeRDP installed${normal}"
        xfreerdp --version | head -1
    else
        echo -e "${red}✗ FreeRDP not installed${normal}"
    fi

    if systemctl is-active --quiet docker; then
        echo -e "${green}✓ Docker running${normal}"
    else
        echo -e "${yellow}⚠ Docker not running${normal}"
        echo "Start with: sudo systemctl start docker"
    fi

    echo ""
    echo "Usage:"
    echo "  ujust winboat-launch    # Start WinBoat GUI"
    echo "  winboat                 # Direct command"
    echo ""
    echo "Documentation:"
    echo "  https://github.com/TibixDev/winboat"

# Enable passwordless sudo for wheel group
enable-passwordless-sudo:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Enable Passwordless Sudo${normal}"
    echo ""
    echo -e "${yellow}⚠️  WARNING: Security Implications${normal}"
    echo "This will enable passwordless sudo for all wheel group members."
    echo ""
    echo "Effects:"
    echo "  - Terminal sudo commands will NOT require password"
    echo "  - GUI admin actions will NOT require password"
    echo "  - Reduces system security significantly"
    echo ""
    echo -e "${bold}Recommended only for:${normal}"
    echo "  - Single-user development workstations"
    echo "  - Testing/experimentation environments"
    echo "  - Systems with physical security"
    echo ""
    echo -e "${red}NOT recommended for:${normal}"
    echo "  - Multi-user systems"
    echo "  - Production environments"
    echo "  - Shared workstations"
    echo ""

    read -p "Continue? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 1
    fi

    echo ""
    echo "Enabling passwordless sudo..."

    # Verify user is in wheel group
    if ! groups | grep -q '\bwheel\b'; then
        echo -e "${red}${bold}Error:${normal} Current user is not in wheel group"
        echo "Add yourself to wheel: sudo usermod -aG wheel $USER"
        exit 1
    fi

    # Modify sudoers to enable NOPASSWD for wheel
    sudo sed -i -e '/^%wheel\s\+ALL=(ALL)\s\+ALL/s/^/# /' \
                -e '/^# %wheel\s\+ALL=(ALL)\s\+NOPASSWD: ALL/s/^# //' \
                /etc/sudoers

    # Create polkit rule for passwordless GUI admin actions
    echo 'polkit.addRule(function(action, subject) {
        if (subject.isInGroup("wheel")) {
            return polkit.Result.YES;
        }
    });' | sudo tee /etc/polkit-1/rules.d/10-passwordless-all.rules > /dev/null

    sudo chmod 644 /etc/polkit-1/rules.d/10-passwordless-all.rules
    sudo chown root:root /etc/polkit-1/rules.d/10-passwordless-all.rules

    # Restart polkit to apply changes
    sudo systemctl restart polkit

    echo ""
    echo -e "${green}${bold}✓ Passwordless sudo enabled${normal}"
    echo ""
    echo "Changes applied:"
    echo "  - /etc/sudoers: NOPASSWD enabled for wheel group"
    echo "  - /etc/polkit-1/rules.d/10-passwordless-all.rules: Created"
    echo "  - polkit service: Restarted"
    echo ""
    echo "To revert: ujust disable-passwordless-sudo"

# Disable passwordless sudo for wheel group
disable-passwordless-sudo:
    #!/usr/bin/bash
    set -euo pipefail
    source /usr/lib/ujust/ujust.sh 2>/dev/null || true

    echo -e "${bold}Disable Passwordless Sudo${normal}"
    echo ""
    echo "This will restore password requirement for sudo commands."
    echo ""

    read -p "Continue? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Aborted."
        exit 1
    fi

    echo ""
    echo "Disabling passwordless sudo..."

    # Revert sudoers changes
    sudo sed -i -e '/^# %wheel\s\+ALL=(ALL)\s\+ALL/s/^# //' \
                -e '/^%wheel\s\+ALL=(ALL)\s\+NOPASSWD: ALL/s/^/# /' \
                /etc/sudoers

    # Remove polkit rule
    if [ -f /etc/polkit-1/rules.d/10-passwordless-all.rules ]; then
        sudo rm -f /etc/polkit-1/rules.d/10-passwordless-all.rules
    fi

    # Restart polkit to apply changes
    sudo systemctl restart polkit

    echo ""
    echo -e "${green}${bold}✓ Passwordless sudo disabled${normal}"
    echo ""
    echo "Changes applied:"
    echo "  - /etc/sudoers: Password required for wheel group"
    echo "  - /etc/polkit-1/rules.d/10-passwordless-all.rules: Removed"
    echo "  - polkit service: Restarted"
    echo ""
    echo "Terminal sudo and GUI admin actions now require password."
